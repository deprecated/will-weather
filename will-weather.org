#+PROPERTY: header-args    :exports both
* Getting my weather data from Netatmos station

** Installing Python netatmo api library
+ There are two
+ This one seems the best
  + https://github.com/rene-d/netatmo
  + [[file:~/Source/netatmo/]]
** Setting credentials
+ These are in my [[file:~/.netatmorc]]
+ Passwords and keys are also stored in 1Password vault
** Available stations
#+BEGIN_SRC sh :results verbatim :exports both
~/Source/netatmo/netatmo.py list
#+END_SRC

#+RESULTS:
: 1 station 70:ee:50:22:ce:e6 Privada Hijos del Ejército Morelia MX
:    module 70:ee:50:22:ce:e6 indoor Temperature,CO2,Humidity,Noise,Pressure
:    module 02:00:00:22:b8:7e outdoor Temperature,Humidity
:    module 05:00:00:02:d3:6c Rain Gauge Rain
** TODO Deal with the rain gauge
- This shows up in the available stations, but I am not sure how to grab the data from it
** Download data into CSV files
Run this periodically - it should just grab the new data

#+BEGIN_SRC sh :results verbatim :exports both
~/Source/netatmo/netatmo.py fetch
#+END_SRC

#+RESULTS:
#+begin_example
station_name : Privada Hijos del Ejército
device_id    : 70:ee:50:22:ce:e6
module_name  : indoor
data_type    : ['Temperature', 'CO2', 'Humidity', 'Noise', 'Pressure']
module_id    : 02:00:00:22:b8:7e
module_name  : outdoor
data_type    : ['Temperature', 'Humidity']
getmeasure 1 date_begin=1529933407 Mon Jun 25 08:30:07 2018
getmeasure 2 date_begin=1530241158 Thu Jun 28 21:59:18 2018
getmeasure 3 date_begin=1530548865 Mon Jul  2 11:27:45 2018
getmeasure 4 date_begin=1530857552 Fri Jul  6 01:12:32 2018
getmeasure 5 date_begin=1531165880 Mon Jul  9 14:51:20 2018
getmeasure 6 date_begin=1531473668 Fri Jul 13 04:21:08 2018
getmeasure 7 date_begin=1531783171 Mon Jul 16 18:19:31 2018
getmeasure 8 date_begin=1532090995 Fri Jul 20 07:49:55 2018
getmeasure 9 date_begin=1532399147 Mon Jul 23 21:25:47 2018
getmeasure 10 date_begin=1532707148 Fri Jul 27 10:59:08 2018
getmeasure 11 date_begin=1533015052 Tue Jul 31 00:30:52 2018
getmeasure 12 date_begin=1533323342 Fri Aug  3 14:09:02 2018
getmeasure 13 date_begin=1533628800 Tue Aug  7 03:00:00 2018
getmeasure 14 date_begin=1533936513 Fri Aug 10 16:28:33 2018
getmeasure 15 date_begin=1534245074 Tue Aug 14 06:11:14 2018
getmeasure 16 date_begin=1534552619 Fri Aug 17 19:36:59 2018
getmeasure 17 date_begin=1534858776 Tue Aug 21 08:39:36 2018
getmeasure 1 date_begin=1529933378 Mon Jun 25 08:29:38 2018
getmeasure 2 date_begin=1530262223 Fri Jun 29 03:50:23 2018
getmeasure 3 date_begin=1530574361 Mon Jul  2 18:32:41 2018
getmeasure 4 date_begin=1530883768 Fri Jul  6 08:29:28 2018
getmeasure 5 date_begin=1531192437 Mon Jul  9 22:13:57 2018
getmeasure 6 date_begin=1531501935 Fri Jul 13 12:12:15 2018
getmeasure 7 date_begin=1531811341 Tue Jul 17 02:09:01 2018
getmeasure 8 date_begin=1532119262 Fri Jul 20 15:41:02 2018
getmeasure 9 date_begin=1532427439 Tue Jul 24 05:17:19 2018
getmeasure 10 date_begin=1532735699 Fri Jul 27 18:54:59 2018
getmeasure 11 date_begin=1533043619 Tue Jul 31 08:26:59 2018
getmeasure 12 date_begin=1533360966 Sat Aug  4 00:36:06 2018
getmeasure 13 date_begin=1533679992 Tue Aug  7 17:13:12 2018
getmeasure 14 date_begin=1534014125 Sat Aug 11 14:02:05 2018
getmeasure 15 date_begin=1534383203 Wed Aug 15 20:33:23 2018
getmeasure 16 date_begin=1534777222 Mon Aug 20 10:00:22 2018
#+end_example
** DONE Make graphs
CLOSED: [2018-03-11 Sun 00:02]
*** Inside and outside temperature and humidity
#+BEGIN_SRC python :return plotfile :results file :exports both
  import pandas as pd
  from matplotlib import pyplot as plt
  import seaborn as sns

  df_inside = pd.read_csv("netatmo_station.csv", sep=';', index_col=1, parse_dates=True)
  df_outside = pd.read_csv("netatmo_module.csv", sep=';', index_col=1, parse_dates=True)

  plotfile = "weather-test.png"

  fig, (ax2, ax) = plt.subplots(2, 1, sharex=True, figsize=(15, 7))

  ax2.plot(df_inside.index.to_pydatetime(), df_inside.Humidity, label="inside")
  ax2.plot(df_outside.index.to_pydatetime(), df_outside.Humidity, label="outside")
  ax2.legend()
  ax2.set(
      ylabel="Humidity, Percent"
  )

  ax.plot(df_inside.index.to_pydatetime(), df_inside.Temperature, label="inside")
  ax.plot(df_outside.index.to_pydatetime(), df_outside.Temperature, label="outside")
  ax.legend()
  ax.set(
      xlabel="Date",
      ylabel="Temperature, Celsius"
  )

  fig.savefig(plotfile)
  fig.savefig(plotfile.replace(".png", ".pdf"))


#+END_SRC

#+RESULTS:
[[file:weather-test.png]]
*** Pressure, CO_2, and noise 


#+BEGIN_SRC python :return plotfile :results file :exports both
  import pandas as pd
  from matplotlib import pyplot as plt
  import seaborn as sns

  df_inside = pd.read_csv("netatmo_station.csv", sep=';', index_col=1, parse_dates=True)
  df_outside = pd.read_csv("netatmo_module.csv", sep=';', index_col=1, parse_dates=True)

  plotfile = "noise-test.png"

  fig, (ax3, ax2, ax) = plt.subplots(3, 1, sharex=True, figsize=(15, 10))

  ax3.fill_between(df_inside.index.to_pydatetime(), df_inside.Pressure, y2=800.0, label="Pressure")
  ax3.legend(loc="upper left")
  ax3.set(
      ylabel="Pressure, mB"
  )

  ax2.fill_between(df_inside.index.to_pydatetime(), df_inside.CO2, y2=330.0, label="CO2")
  ax2.legend(loc="upper left")
  ax2.set(
      ylabel="CO$_{2}$, ppm",
      ylim=[310.0, None],
  )

  ax.fill_between(df_inside.index.to_pydatetime(), df_inside.Noise, y2=33.0, label="Noise")
  ax.legend(loc="upper left")
  ax.set(
      xlabel="Date",
      ylabel="Noise, dB"
  )

  fig.savefig(plotfile)
  fig.savefig(plotfile.replace(".png", ".pdf"))


#+END_SRC

#+RESULTS:
[[file:noise-test.png]]
*** Two-factor pair graphs

Correlations between selected measurements.  This takes about a 20 seconds to run.
#+BEGIN_SRC python :return figfile :results file :exports both
  import numpy as np
  import pandas as pd
  from matplotlib import pyplot as plt
  import seaborn as sns

  sns.set_color_codes('dark')

  df_inside = pd.read_csv("netatmo_station.csv", sep=';', index_col=1, parse_dates=True)
  df_outside = pd.read_csv("netatmo_module.csv", sep=';', index_col=1, parse_dates=True)

  figfile = "weather-pairplot.png"

  # Resample by day and by hour
  dfi_max_day = df_inside.resample('1D').max()
  dfi_min_day = df_inside.resample('1D').min()
  dfi_med_hr = df_inside.resample('1H').mean()

  dfo_med_hr = df_outside.resample('1H').mean()

  # Restrict to afternoons, 12am to 5pm
  # pm_indices = dfi_med_hr.index.indexer_between_time('12:00', '17:00')

  # Restrict to daytime: 
  day_indices = dfi_med_hr.index.indexer_between_time('07:00', '19:00')

  df = dfi_med_hr.join(dfo_med_hr, rsuffix=" out")
  df = df.iloc[day_indices]
  df = df.fillna(method='bfill')
  # df = dfi_min_day
  variables = ['Temperature', 'Temperature out', 'CO2', 'Humidity', 'Humidity out', 'Noise', 'Pressure']
  g = sns.PairGrid(df, vars=variables, size=1.5)
  g = g.map_upper(plt.scatter, marker='.', alpha=0.1, facecolor='r', edgecolor='none')
  g = g.map_lower(sns.kdeplot, cmap="Purples_d", n_levels=10)
  g = g.map_diag(plt.hist)
  g.fig.suptitle("Hourly means, daytime only (7AM-7PM)")
  g.savefig(figfile)


  # Repeat for night time
  night_indices = dfi_med_hr.index.indexer_between_time('19:00', '07:00')
  df = dfi_med_hr.join(dfo_med_hr, rsuffix=" out")
  df = df.iloc[night_indices]
  df = df.fillna(method='bfill')
  variables = ['Temperature', 'Temperature out', 'CO2', 'Humidity', 'Humidity out', 'Noise', 'Pressure']
  g = sns.PairGrid(df, vars=variables, size=1.5)
  g = g.map_upper(plt.scatter, marker='.', alpha=0.1, facecolor='r', edgecolor='none')
  g = g.map_lower(sns.kdeplot, cmap="Purples_d", n_levels=10)
  g = g.map_diag(plt.hist)
  g.fig.suptitle("Hourly means, nighttime only (7PM-7AM)")
  g.savefig(figfile.replace(".png", "-night.png"))

#+END_SRC

#+RESULTS:
[[file:weather-pairplot.png]]

Also, the night-time version:
[[file:weather-pairplot-night.png]]
